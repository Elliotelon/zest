# fastlane/Fastfile

default_platform(:ios)

platform :ios do
  
  # 모든 레인 실행 전에 API Key를 설정합니다.
  before_all do
    if !is_ci
      xcode_select("/Applications/Xcode.app")
    end

  end

  desc "유닛 테스트 실행 (CI용)"
  lane :test do
  
    sh("swift test --package-path ../ZestCore")

    ENV["FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT"] = "100"
    ENV["FASTLANE_XCODEBUILD_SETTINGS_RETRIES"] = "5"
    
    
    scan(
      project: "Zest.xcodeproj", # Workspace 에러 방지
      scheme: "Zest",
      destination: "platform=iOS Simulator,name=iPhone 16,OS=18.6",
      fail_build: true,
      prelaunch_simulator: true,
      clean: false
    )
  end

  desc "TestFlight에 베타 빌드 배포 (CD용)"
  lane :beta do
    UI.user_error!("APP_STORE_CONNECT_API_KEY_ID missing") if ENV["APP_STORE_CONNECT_API_KEY_ID"].nil?

    # 0️⃣ match로 코드 서명 설정 적용
    match(
      type: "appstore",
      readonly: true,
      git_url: ENV["MATCH_GIT_URL"]
    )

    # 1️⃣ App Store Connect API Key 인증 설정
    api_key = app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_API_KEY_CONTENT"],
      is_key_content_base64: false
    )

    # 2️⃣ 빌드 번호 자동 증가
    increment_build_number(xcodeproj: "Zest.xcodeproj")

    # 3️⃣ 아카이브 빌드
    build_app(
      project: "Zest.xcodeproj",
      scheme: "Zest",
      include_bitcode: false,
      export_method: "app-store",
      export_xcargs: "-allowProvisioningUpdates",
      export_team_id: "A3GL2XU4F8"
    )

    # 4️⃣ TestFlight 업로드
    upload_to_testflight(
      api_key: api_key,
      skip_waiting_for_build_processing: true,
      skip_submission: true
    )
  end

  error do |lane, exception|
    # 필요 시 Slack/Notion/Email 알림 추가
  end
end

